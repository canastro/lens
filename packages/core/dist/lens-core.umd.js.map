{"version":3,"file":"lens-core.umd.js","sources":["../node_modules/workerize/dist/workerize.m.js","../src/index.js"],"sourcesContent":["function e(e,t,n){e.addEventListener(\"message\",function(r){var o=r.data,a=o.id;if(\"RPC\"===o.type&&null!=a)if(o.method){var s=t[o.method];null==s?e.postMessage({type:\"RPC\",id:a,error:\"NO_SUCH_METHOD\"}):Promise.resolve().then(function(){return s.apply(null,o.params)}).then(function(t){e.postMessage({type:\"RPC\",id:a,result:t})}).catch(function(t){e.postMessage({type:\"RPC\",id:a,error:\"\"+t})})}else{var i=n[a];if(null==i)throw Error(\"Unknown callback \"+a);delete n[a],o.error?i[1](Error(o.error)):i[0](o.result)}})}export default function(t,n){var r=this,o={},a=\"__xpo\"+Math.random().toString().substring(2)+\"__\";\"function\"==typeof t&&(t=\"(\"+Function.prototype.toString.call(t)+\")(\"+a+\")\"),t=function(e,t,n){return e=(e=e.replace(/^(\\s*)export\\s+default\\s+/m,function(e,r){return n.default=!0,\"\"+r+t+\".default=\"})).replace(/^(\\s*)export\\s+((?:async\\s*)?function(?:\\s*\\*)?|const|let|var)(\\s+)([a-zA-Z$_][a-zA-Z0-9$_]*)/gm,function(e,r,o,a,s){return n[s]=!0,\"\"+r+t+\".\"+s+\"=\"+o+a+s}),\"var \"+t+\"={};\\n\"+e+\"\\n\"+t+\";\"}(t,a,o)+\"\\n(\"+Function.prototype.toString.call(e)+\")(self,\"+a+\",{})\";var s,i=URL.createObjectURL(new Blob([t])),l=new Worker(i,n),c=l.terminate,u={},p=0;for(s in l.kill=function(e){l.postMessage({type:\"KILL\",signal:e}),setTimeout(l.terminate)},l.terminate=function(){URL.revokeObjectURL(i),c.call(r)},l.call=function(e,t){return new Promise(function(n,r){var o=\"rpc\"+ ++p;u[o]=[n,r],l.postMessage({type:\"RPC\",id:o,method:e,params:t})})},l.rpcMethods={},e(l,l.rpcMethods,u),l.expose=function(e){l[s]=function(){return l.call(e,[].slice.call(arguments))}},o)s in l||l.expose(s);return l};\n//# sourceMappingURL=workerize.m.js.map\n","import workerize from 'workerize';\n\n/**\n * It returns a canvas with the given width and height\n * @param {Number} w - width\n * @param {Number} h - height\n * @returns {Object}\n */\nfunction getCanvas(w, h) {\n    const canvas = document.createElement('canvas');\n    canvas.width = w;\n    canvas.height = h;\n\n    return canvas;\n}\n\n/**\n * Given a ImageData it returns the dataURL\n * @param {ImageData} imageData\n * @returns {String}\n */\nfunction convertImageDataToCanvasURL(imageData) {\n    const canvas = window.document.createElement('canvas');\n    const ctx = canvas.getContext('2d');\n    canvas.width = imageData.width;\n    canvas.height = imageData.height;\n    ctx.putImageData(imageData, 0, 0);\n\n    return canvas.toDataURL();\n}\n\n/**\n * Given a worker file with the transformation the work is split\n * between the configured number of workers and the transformation is applied\n * returning a Promise\n * @param {Object} data - image data\n * @param {Function} transform - transformation function\n * @param {Object} options - object to be passed to the transform function\n * @param {Number} nWorkers - number of workers to transform the image\n * @returns {Promise}\n */\nfunction applyFilter({ data, transform, options, nWorkers }) {\n    const worker = workerize(`\n        var transform = ${transform};\n\n        export function execute(canvas, index, length, options) {\n            canvas.data = transform({ \n                data: canvas.data, \n                length: length, \n                options: options\n            });\n\n            return { result: canvas, index: index };\n        }\n    `);\n\n    // Drawing the source image into the target canvas\n    const canvas = getCanvas(data.width, data.height);\n    const context = canvas.getContext('2d');\n    context.putImageData(data, 0, 0);\n\n    // Minimium 1 worker\n    nWorkers = nWorkers || 1;\n\n    // Height of the picture chunck for every worker\n    const blockSize = Math.floor(canvas.height / nWorkers);\n\n    return new Promise(resolve => {\n        let finished = 0;\n        let height;\n\n        for (let index = 0; index < nWorkers; index++) {\n            // In the last worker we have to make sure we process whatever is missing\n            height = blockSize;\n\n            if (index + 1 === nWorkers) {\n                height = canvas.height - blockSize * index;\n            }\n\n            // Getting the picture\n            const canvasData = context.getImageData(\n                0,\n                blockSize * index,\n                canvas.width,\n                height\n            );\n            const length = height * canvas.width * 4;\n\n            worker\n                .execute(canvasData, index, length, options)\n                .then(response => {\n                    // Copying back canvas data to canvas\n                    // If the first webworker  (index 0) returns data, apply it at pixel (0, 0) onwards\n                    // If the second webworker  (index 1) returns data, apply it at pixel (0, canvas.height/4) onwards, and so on\n                    context.putImageData(\n                        response.result,\n                        0,\n                        blockSize * response.index\n                    );\n\n                    finished++;\n\n                    if (finished === nWorkers) {\n                        resolve(\n                            context.getImageData(\n                                0,\n                                0,\n                                canvas.width,\n                                canvas.height\n                            )\n                        );\n                    }\n                });\n        }\n    });\n}\n\nexports.getCanvas = getCanvas;\nexports.convertImageDataToCanvasURL = convertImageDataToCanvasURL;\nexports.applyFilter = applyFilter;\n"],"names":["e","t","n","addEventListener","r","o","data","a","id","type","method","s","postMessage","error","Promise","resolve","then","apply","params","result","catch","i","Error","getCanvas","w","h","canvas","document","createElement","width","height","exports","convertImageDataToCanvasURL","imageData","window","ctx","getContext","putImageData","toDataURL","applyFilter","transform","options","nWorkers","worker","this","Math","random","toString","substring","Function","prototype","call","replace","default","URL","createObjectURL","Blob","l","Worker","c","terminate","u","p","kill","signal","setTimeout","revokeObjectURL","rpcMethods","expose","slice","arguments","workerize","context","blockSize","floor","finished","index","canvasData","getImageData","length","execute","response"],"mappings":"uJAAA,SAASA,EAAEA,EAAEC,EAAEC,GAAGF,EAAEG,iBAAiB,UAAU,SAASC,GAAG,IAAIC,EAAED,EAAEE,KAAKC,EAAEF,EAAEG,GAAG,GAAG,QAAQH,EAAEI,MAAM,MAAMF,EAAE,GAAGF,EAAEK,OAAO,CAAC,IAAIC,EAAEV,EAAEI,EAAEK,QAAQ,MAAMC,EAAEX,EAAEY,YAAY,CAACH,KAAK,MAAMD,GAAGD,EAAEM,MAAM,mBAAmBC,QAAQC,UAAUC,KAAK,WAAW,OAAOL,EAAEM,MAAM,KAAKZ,EAAEa,UAAUF,KAAK,SAASf,GAAGD,EAAEY,YAAY,CAACH,KAAK,MAAMD,GAAGD,EAAEY,OAAOlB,MAAMmB,MAAM,SAASnB,GAAGD,EAAEY,YAAY,CAACH,KAAK,MAAMD,GAAGD,EAAEM,MAAM,GAAGZ,UAAU,CAAC,IAAIoB,EAAEnB,EAAEK,GAAG,GAAG,MAAMc,EAAE,MAAMC,MAAM,oBAAoBf,UAAUL,EAAEK,GAAGF,EAAEQ,MAAMQ,EAAE,GAAGC,MAAMjB,EAAEQ,QAAQQ,EAAE,GAAGhB,EAAEc,WCQtf,SAASI,EAAUC,EAAGC,OACZC,EAASC,SAASC,cAAc,mBAC/BC,MAAQL,IACRM,OAASL,EAETC,EAwGXK,QAAQR,UAAYA,EACpBQ,QAAQC,4BAjGR,SAAqCC,OAC3BP,EAASQ,OAAOP,SAASC,cAAc,UACvCO,EAAMT,EAAOU,WAAW,eACvBP,MAAQI,EAAUJ,QAClBC,OAASG,EAAUH,SACtBO,aAAaJ,EAAW,EAAG,GAExBP,EAAOY,aA2FlBP,QAAQQ,YA9ER,gBAAuBjC,IAAAA,KAAMkC,IAAAA,UAAWC,IAAAA,QAASC,IAAAA,SACvCC,ED1Cuf,SAAwB1C,EAAEC,GAAG,IAA6JF,EAAEC,EAAEC,EAA7JE,EAAEwC,KAAKvC,EAAE,GAAGE,EAAE,QAAQsC,KAAKC,SAASC,WAAWC,UAAU,GAAG,KAAK,mBAAmB/C,IAAIA,EAAE,IAAIgD,SAASC,UAAUH,SAASI,KAAKlD,GAAG,KAAKM,EAAE,KAAkBN,EAAwTM,EAAtTL,EAAwTG,EAA9SL,GAAGA,GAAjBA,EAAwTC,GAAnSmD,QAAQ,6BAA6B,SAASpD,EAAEI,GAAG,OAAOF,EAAEmD,SAAQ,EAAG,GAAGjD,EAAEH,EAAE,eAAemD,QAAQ,kGAAkG,SAASpD,EAAEI,EAAEC,EAAEE,EAAEI,GAAG,OAAOT,EAAES,IAAG,EAAG,GAAGP,EAAEH,EAAE,IAAIU,EAAE,IAAIN,EAAEE,EAAEI,IAA/RV,EAAmS,OAAOA,EAAE,SAASD,EAAE,KAAKC,EAAE,OAAkBgD,SAASC,UAAUH,SAASI,KAAKnD,GAAG,UAAUO,EAAE,OAAO,IAAII,EAAEU,EAAEiC,IAAIC,gBAAgB,IAAIC,KAAK,CAACvD,KAAKwD,EAAE,IAAIC,OAAOrC,EAAEnB,GAAGyD,EAAEF,EAAEG,UAAUC,EAAE,GAAGC,EAAE,EAAE,IAAInD,KAAK8C,EAAEM,KAAK,SAAS/D,GAAGyD,EAAE7C,YAAY,CAACH,KAAK,OAAOuD,OAAOhE,IAAIiE,WAAWR,EAAEG,YAAYH,EAAEG,UAAU,WAAWN,IAAIY,gBAAgB7C,GAAGsC,EAAER,KAAK/C,IAAIqD,EAAEN,KAAK,SAASnD,EAAEC,GAAG,OAAO,IAAIa,QAAQ,SAASZ,EAAEE,GAAG,IAAIC,EAAE,SAASyD,EAAED,EAAExD,GAAG,CAACH,EAAEE,GAAGqD,EAAE7C,YAAY,CAACH,KAAK,MAAMD,GAAGH,EAAEK,OAAOV,EAAEkB,OAAOjB,OAAOwD,EAAEU,WAAW,GAAGnE,EAAEyD,EAAEA,EAAEU,WAAWN,GAAGJ,EAAEW,OAAO,SAASpE,GAAGyD,EAAE9C,GAAG,WAAW,OAAO8C,EAAEN,KAAKnD,EAAE,GAAGqE,MAAMlB,KAAKmB,cAAcjE,EAAEM,KAAK8C,GAAGA,EAAEW,OAAOzD,GAAG,OAAO8C,EC0CtiDc,8BACO/B,uTAchBd,EAASH,EAAUjB,EAAKuB,MAAOvB,EAAKwB,QACpC0C,EAAU9C,EAAOU,WAAW,QAC1BC,aAAa/B,EAAM,EAAG,KAGnBoC,GAAY,MAGjB+B,EAAY5B,KAAK6B,MAAMhD,EAAOI,OAASY,UAEtC,IAAI5B,QAAQ,oBACX6D,EAAW,EACX7C,SAEK8C,EAAQ,EAAGA,EAAQlC,EAAUkC,IAAS,GAElCH,EAELG,EAAQ,IAAMlC,MACLhB,EAAOI,OAAS2C,EAAYG,OAInCC,EAAaL,EAAQM,aACvB,EACAL,EAAYG,EACZlD,EAAOG,MACPC,GAEEiD,EAASjD,EAASJ,EAAOG,MAAQ,IAGlCmD,QAAQH,EAAYD,EAAOG,EAAQtC,GACnCzB,KAAK,cAIMqB,aACJ4C,EAAS9D,OACT,EACAsD,EAAYQ,EAASL,aAKRlC,KAET8B,EAAQM,aACJ,EACA,EACApD,EAAOG,MACPH,EAAOI"}